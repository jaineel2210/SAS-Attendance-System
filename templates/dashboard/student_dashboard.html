{% extends "base.html" %}

{% block title %}Student Dashboard - SecureAttend Pro{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Welcome Section -->
        <div class="col-12 mb-4">
            <div class="card" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white;">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h4 class="mb-1" style="color: white;">Welcome back, {{ session.username }}!</h4>
                            <p class="mb-0" style="color: white;">Enrollment: {{ session.enrollment_no }}</p>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-graduate fa-3x" style="color: white; opacity: 0.8;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Stats -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-success">
                <div class="card-body text-center">
                    <div class="text-success mb-2">
                        <i class="fas fa-percentage fa-2x"></i>
                    </div>
                    <h3 class="fw-bold text-success">{{ attendance_percentage.percentage }}%</h3>
                    <p class="text-muted mb-0">Overall Attendance</p>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="fas fa-calendar-check fa-2x"></i>
                    </div>
                    <h3 class="fw-bold text-primary">{{ attendance_percentage.attended_sessions }}</h3>
                    <p class="text-muted mb-0">Classes Attended</p>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-info">
                <div class="card-body text-center">
                    <div class="text-info mb-2">
                        <i class="fas fa-calendar fa-2x"></i>
                    </div>
                    <h3 class="fw-bold text-info">{{ attendance_percentage.total_sessions }}</h3>
                    <p class="text-muted mb-0">Total Classes</p>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <div class="text-warning mb-2">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                    <h3 class="fw-bold text-warning">{{ attendance_percentage.total_sessions -
                        attendance_percentage.attended_sessions }}</h3>
                    <p class="text-muted mb-0">Classes Missed</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Quick Actions -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="startQRScanner()">
                            <i class="fas fa-qrcode me-2"></i>Scan QR for Attendance
                        </button>
                        <a href="{{ url_for('mark_attendance') }}" class="btn btn-primary">
                            <i class="fas fa-fingerprint me-2"></i>Mark Attendance (Face/RFID)
                        </a>
                        <a href="{{ url_for('analytics_page') }}" class="btn btn-info">
                            <i class="fas fa-chart-bar me-2"></i>View Analytics
                        </a>
                    </div>

                    <hr>

                    <div class="text-center">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Scan faculty QR code or use face recognition + RFID card
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Attendance -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Attendance</h5>
                    <span class="badge bg-primary">Last 10 Records</span>
                </div>
                <div class="card-body">
                    {% if attendance_data %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Subject</th>
                                    <th>Type</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Method</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in attendance_data[:10] %}
                                <tr>
                                    <td>{{ record.attendance_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ record.subject }}</td>
                                    <td>
                                        <span
                                            class="badge bg-{% if record.session_type == 'lecture' %}info{% else %}warning{% endif %}">
                                            {{ record.session_type.title() }}
                                        </span>
                                    </td>
                                    <td>{{ record.attendance_time.strftime('%H:%M') }}</td>
                                    <td>
                                        <span
                                            class="attendance-badge attendance-{% if record.status == 'P' %}present{% else %}absent{% endif %}">
                                            {{ 'Present' if record.status == 'P' else 'Absent' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if record.marked_by_face %}
                                        <i class="fas fa-face-smile text-primary" title="Face Recognition"></i>
                                        {% endif %}
                                        {% if record.marked_by_rfid %}
                                        <i class="fas fa-id-card text-success ms-1" title="RFID Card"></i>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No attendance records found</p>
                        <a href="{{ url_for('mark_attendance') }}" class="btn btn-primary">
                            Mark Your First Attendance
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Subject-wise Attendance -->
    {% if subject_wise_data %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-book me-2"></i>Subject-wise Attendance</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for subject in subject_wise_data %}
                        <div class="col-lg-6 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">{{ subject.subject }}</h6>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="fw-bold text-primary">{{ subject.overall_percentage }}%</div>
                                            <small class="text-muted">Overall</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="fw-bold text-info">{{ subject.lecture_percentage }}%</div>
                                            <small class="text-muted">Lectures</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="fw-bold text-warning">{{ subject.lab_percentage }}%</div>
                                            <small class="text-muted">Labs</small>
                                        </div>
                                    </div>
                                    <div class="progress mt-2" style="height: 6px;">
                                        <div class="progress-bar bg-primary"
                                            style="width: {{ subject.overall_percentage }}%">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-book me-2"></i>Subject-wise Attendance</h5>
                </div>
                <div class="card-body text-center">
                    <div class="text-muted">
                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                        <p>No subject-wise attendance data available yet.</p>
                        <p class="small">Start marking attendance to see your progress!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Attendance Guidelines -->
    <div class="row">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Attendance Guidelines</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-check-circle text-success me-2"></i>How to Mark Attendance</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-arrow-right text-primary me-2"></i>Position your face clearly in
                                    front of the camera</li>
                                <li><i class="fas fa-arrow-right text-primary me-2"></i>Tap your RFID card on the reader
                                </li>
                                <li><i class="fas fa-arrow-right text-primary me-2"></i>Wait for confirmation message
                                </li>
                                <li><i class="fas fa-arrow-right text-primary me-2"></i>Attendance marked automatically
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Important Notes</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-arrow-right text-warning me-2"></i>Ensure good lighting for face
                                    recognition</li>
                                <li><i class="fas fa-arrow-right text-warning me-2"></i>One attendance per session per
                                    subject</li>
                                <li><i class="fas fa-arrow-right text-warning me-2"></i>Both face and RFID verification
                                    required</li>
                                <li><i class="fas fa-arrow-right text-warning me-2"></i>Contact admin for any issues
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1" aria-labelledby="qrScannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrScannerModalLabel">
                    <i class="fas fa-qrcode me-2"></i>Scan Attendance QR Code
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Status Message -->
                <div id="qrScanStatus" class="alert d-none" role="alert"></div>

                <!-- Camera Section -->
                <div id="qrCameraSection">
                    <div class="text-center mb-3">
                        <p class="text-muted">Position the QR code within the camera frame</p>
                    </div>

                    <!-- Video Element for Camera -->
                    <div class="text-center mb-3">
                        <video id="qrVideo" width="100%" height="300"
                            style="border: 2px solid #ddd; border-radius: 8px;" autoplay></video>
                    </div>

                    <!-- Canvas for QR Code Processing (hidden) -->
                    <canvas id="qrCanvas" style="display: none;"></canvas>

                    <!-- Manual QR Input Fallback -->
                    <div class="mt-3">
                        <label for="manualQRInput" class="form-label">Or enter QR data manually:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="manualQRInput"
                                placeholder="Paste QR code data here">
                            <button class="btn btn-primary" type="button" onclick="processManualQR()">
                                <i class="fas fa-check me-1"></i>Submit
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Face Verification Section (shown after QR scan) -->
                <div id="faceVerificationSection" class="d-none">
                    <div class="text-center mb-3">
                        <h6><i class="fas fa-user-check me-2 text-success"></i>QR Code Verified - Face Verification
                            Required</h6>
                        <p class="text-muted">Please look at the camera for face verification</p>
                    </div>

                    <div class="text-center mb-3">
                        <video id="faceVideo" width="100%" height="300"
                            style="border: 2px solid #28a745; border-radius: 8px;" autoplay></video>
                    </div>

                    <div class="text-center">
                        <button class="btn btn-success btn-lg" onclick="completeFaceVerification()">
                            <i class="fas fa-check-circle me-2"></i>Complete Verification
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="startCameraBtn" onclick="startQRCamera()">
                    <i class="fas fa-camera me-1"></i>Start Camera
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include QR Code Library -->
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

<script>
    let qrStream = null;
    let faceStream = null;
    let qrScanInterval = null;
    let scannedQRData = null;

    // Show QR Scanner Modal
    function startQRScanner() {
        const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
        modal.show();
    }

    // Start Camera for QR Scanning
    async function startQRCamera() {
        try {
            const video = document.getElementById('qrVideo');
            qrStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' } // Use back camera if available
            });
            video.srcObject = qrStream;

            // Start QR scanning
            startQRScanning();

            // Update button
            document.getElementById('startCameraBtn').innerHTML = '<i class="fas fa-stop me-1"></i>Stop Camera';
            document.getElementById('startCameraBtn').onclick = stopQRCamera;

            showQRStatus('Camera started. Position QR code in the frame.', 'info');

        } catch (error) {
            console.error('Error accessing camera:', error);
            showQRStatus('Error accessing camera. Please check permissions.', 'danger');
        }
    }

    // Stop QR Camera
    function stopQRCamera() {
        if (qrStream) {
            qrStream.getTracks().forEach(track => track.stop());
            qrStream = null;
        }

        if (qrScanInterval) {
            clearInterval(qrScanInterval);
            qrScanInterval = null;
        }

        // Reset button
        document.getElementById('startCameraBtn').innerHTML = '<i class="fas fa-camera me-1"></i>Start Camera';
        document.getElementById('startCameraBtn').onclick = startQRCamera;

        showQRStatus('Camera stopped.', 'secondary');
    }

    // Start QR Code Scanning
    function startQRScanning() {
        const video = document.getElementById('qrVideo');
        const canvas = document.getElementById('qrCanvas');
        const context = canvas.getContext('2d');

        qrScanInterval = setInterval(() => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    console.log('QR Code detected:', code.data);
                    processQRCode(code.data);
                }
            }
        }, 300); // Scan every 300ms
    }

    // Process QR Code Data
    async function processQRCode(qrData) {
        // Stop scanning
        if (qrScanInterval) {
            clearInterval(qrScanInterval);
            qrScanInterval = null;
        }

        scannedQRData = qrData;
        showQRStatus('QR Code detected! Processing...', 'info');

        try {
            const response = await fetch('/scan_attendance_qr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'include',
                body: JSON.stringify({
                    qr_data: qrData,
                    step: 'qr_scan'
                })
            });

            const result = await response.json();

            if (result.success) {
                if (result.requires_face_verification) {
                    // QR valid, now need face verification
                    showQRStatus('QR Code valid! Please complete face verification.', 'success');
                    showFaceVerificationSection();
                } else {
                    // Attendance marked directly (shouldn't happen for students)
                    showQRStatus('Attendance marked successfully!', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            } else {
                showQRStatus('Error: ' + (result.message || 'Invalid QR code'), 'danger');
                // Restart scanning after error
                setTimeout(() => {
                    startQRScanning();
                }, 2000);
            }

        } catch (error) {
            console.error('Error processing QR code:', error);
            showQRStatus('Error processing QR code. Please try again.', 'danger');
            // Restart scanning after error
            setTimeout(() => {
                startQRScanning();
            }, 2000);
        }
    }

    // Process Manual QR Input
    async function processManualQR() {
        const manualInput = document.getElementById('manualQRInput').value.trim();
        if (!manualInput) {
            showQRStatus('Please enter QR code data.', 'warning');
            return;
        }

        await processQRCode(manualInput);
    }

    // Show Face Verification Section
    function showFaceVerificationSection() {
        // Hide QR camera section
        document.getElementById('qrCameraSection').classList.add('d-none');

        // Show face verification section
        document.getElementById('faceVerificationSection').classList.remove('d-none');

        // Start face camera
        startFaceCamera();
    }

    // Start Face Camera
    async function startFaceCamera() {
        try {
            const video = document.getElementById('faceVideo');
            faceStream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = faceStream;

            showQRStatus('Look at the camera for face verification.', 'info');

        } catch (error) {
            console.error('Error accessing camera for face verification:', error);
            showQRStatus('Error accessing camera for face verification.', 'danger');
        }
    }

    // Complete Face Verification
    async function completeFaceVerification() {
        if (!scannedQRData) {
            showQRStatus('No QR data available. Please scan again.', 'danger');
            return;
        }

        try {
            showQRStatus('Processing face verification...', 'info');

            const response = await fetch('/scan_attendance_qr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'include',
                body: JSON.stringify({
                    qr_data: scannedQRData,
                    step: 'face_verification'
                })
            });

            const result = await response.json();

            if (result.success) {
                showQRStatus(`âœ… Attendance marked successfully! Welcome, ${result.student_name || 'Student'}`, 'success');

                // Close modal after success
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('qrScannerModal'));
                    modal.hide();
                    location.reload();
                }, 3000);

            } else {
                showQRStatus('Face verification failed: ' + (result.message || 'Unknown error'), 'danger');
            }

        } catch (error) {
            console.error('Error in face verification:', error);
            showQRStatus('Error in face verification. Please try again.', 'danger');
        }
    }

    // Show Status Message
    function showQRStatus(message, type) {
        const statusElement = document.getElementById('qrScanStatus');
        statusElement.className = `alert alert-${type}`;
        statusElement.textContent = message;
        statusElement.classList.remove('d-none');
    }

    // Cleanup when modal closes
    document.getElementById('qrScannerModal').addEventListener('hidden.bs.modal', function () {
        // Stop all streams
        if (qrStream) {
            qrStream.getTracks().forEach(track => track.stop());
            qrStream = null;
        }

        if (faceStream) {
            faceStream.getTracks().forEach(track => track.stop());
            faceStream = null;
        }

        // Clear intervals
        if (qrScanInterval) {
            clearInterval(qrScanInterval);
            qrScanInterval = null;
        }

        // Reset UI
        document.getElementById('qrCameraSection').classList.remove('d-none');
        document.getElementById('faceVerificationSection').classList.add('d-none');
        document.getElementById('qrScanStatus').classList.add('d-none');
        document.getElementById('manualQRInput').value = '';

        // Reset button
        document.getElementById('startCameraBtn').innerHTML = '<i class="fas fa-camera me-1"></i>Start Camera';
        document.getElementById('startCameraBtn').onclick = startQRCamera;

        scannedQRData = null;
    });
</script>

{% endblock %}